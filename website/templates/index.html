<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bank Database</title>
    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <style>
        html{
            height: 100%;
        }
        body {
            height: 100%;
            background-image:url("../static/backgroud.jpg");
            background-repeat: no-repeat;
            background-attachment:fixed;
            background-size:100% 100%;
        }

        #container {
            background-color: rgba(255, 255, 255, 0.0);
            height: 100%;
            width: 100%;
        }

        #login_bar{
            width:300px;
            position:fixed;
            z-index:10;
            border:0 solid black;
            top:-5px;
            right:150px;
            display:inline-block;
        }
        #login_signup{
            float:right;
            display:inline;
        }
        #login_signup> li{
            height: 50px;
            width: 200px;
            font-family:sans-serif;
            font-size: 22px;
            font-weight: bold;
            color:white;
            padding:5px;
            display:inline-block;
            background-color:#F87982;
            border-radius:5px;
            -moz-border-radius:5px;
            -webkit-border-radius: 5px;
            -o-border-radius:5px;
            box-shadow: #F87982 0px 0px 10px;
            -moz-box-shadow: #F87982 0px 0px 10px;
            -webkit-box-shadow: #F87982 0px 0px 10px;
            -o-box-shadow:#F87982 0px 0px 10px;
        }
        #login_signup li> a{
            height: 50px;
            width: 200px;
            font-family:sans-serif;
            font-size: 22px;
            font-weight: bold;
            color:white;
            padding:5px;
            display:inline-block;
            background-color:#FE4E5B;
            border-radius:5px;
            -moz-border-radius:5px;
            -webkit-border-radius: 5px;
            -o-border-radius:5px;
            box-shadow: #FE4E5B 0px 0px 10px;
            -moz-box-shadow: #FE4E5B 0px 0px 10px;
            -webkit-box-shadow: #FE4E5B 0px 0px 10px;
            -o-box-shadow:#FE4E5B 0px 0px 10px;
        }
        #login_signup li span{
            font-size: 22px;
            display:inline-block;
        }
        .sign_link:hover{
            cursor: pointer;
            box-shadow: rgb(255,255,255) 0px 0px 5px;
            -moz-box-shadow: rgb(255,255,255) 0px 0px 5px;
            -webkit-box-shadow: rgb(255,255,255) 0px 0px 5px;
            -o-box-shadow:rgb(255,255,255) 0px 0px 5px;
            border-radius: 2px;
            background-color: white;
            color:#9E3F3F;
        }
        #cnm{
            width: 70%;
            background: #F7F7F7;
            font: 20px Helvetica Neue, Helvetica, Arial, sans-serif;
            color: #888;
            text-shadow: 1px 1px 1px #FFF;
            border:1px solid #E4E4E4;
        }

        #cols {
            width: 70%;
            height: 70%;
            margin-top: 10%;
            margin-left:auto;
            margin-right:auto;
            background: #F7F7F7;
            padding: 25px 15px 25px 10px;
            font: 20px Helvetica Neue, Helvetica, Arial, sans-serif;
            color: #888;
            text-shadow: 1px 1px 1px #FFF;
            border:1px solid #E4E4E4;
            z-index:-11;
        }

        #qform {
            width: 70%;
            height: 70%;
            margin-top: 10%;
            margin-left:auto;
            margin-right:auto;
            background: #F7F7F7;
            padding: 25px 15px 25px 10px;
            font: 20px Helvetica Neue, Helvetica, Arial, sans-serif;
            color: #888;
            text-shadow: 1px 1px 1px #FFF;
            border:1px solid #E4E4E4;
            z-index:-11;
        }
        #qform h1 {
            font-size: 25px;
            padding: 0px 0px 10px 40px;
            display: block;
            border-bottom:1px solid #E4E4E4;
            margin: -10px -15px 30px -10px;;
            color: #888;
        }
        #qform h1>span {
            display: block;
            font-size: 11px;
        }
        #qform label {
            display: block;
            margin: 0px;
        }
        #qform label>span {
            float: left;
            width: 20%;
            text-align: right;
            padding-right: 10px;
            margin-top: 10px;
            color: #888;
        }
        #qform input[type="text"], .basic-grey input[type="email"], .basic-grey textarea, .basic-grey select {
            border: 1px solid #DADADA;
            color: #888;
            height: 45px;
            margin-bottom: 16px;
            margin-right: 6px;
            margin-top: 2px;
            outline: 0 none;
            padding: 3px 3px 3px 5px;
            width: 70%;
            font-size: 12px;
            line-height:15px;
            box-shadow: inset 0px 1px 4px #ECECEC;
            -moz-box-shadow: inset 0px 1px 4px #ECECEC;
            -webkit-box-shadow: inset 0px 1px 4px #ECECEC;
        }
        #qform textarea{
            padding: 5px 3px 3px 5px;
        }
        #qform textarea{
            height:100px;
        }
        #qform input[type="button"] {
            background: #E27575;
            border: none;
            padding: 10px 25px 10px 25px;
            color: #FFF;
            box-shadow: 1px 1px 5px #B6B6B6;
            border-radius: 3px;
            text-shadow: 1px 1px 1px #9E3F3F;
            cursor: pointer;
        }
        #qform input[type="button"]:hover {
            background: #CF9A9D
        }

        #qform span {
            width: 100%;
            height: 50%;
            border: 1px dashed #9E3F3F;
        }

        .exportbutton {
            background: #984B4B;
            width: 120px;
        }

        .exportbutton:hover{
            background-color: #66CDAA;
        }




    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
<nav class="navbar navbar-dark bg-dark justify-content-end" style="top: 0; left: 0; z-index: 9999; width: 100%; height: auto; position: fixed">
  <ul class="nav justify-content-end">
      <li class="nav-item">
          <a class="nav-link" href="#qform" style ="color:white;font-size:25px;">Query</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" href="#analysis" style ="color:white;font-size:25px;">Analysis</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" href="#prediction" style ="color:white;font-size:25px;">Prediction</a>
      </li>

  <li class="nav-item">
    <a class="nav-link" href="#" style ="color:white;font-size:25px;">Welcome! {{username}}</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" style ="color:white;font-size:25px;" href="/logout">Logout</a>
  </li>
</ul>
</nav>

<div id = "cols">
    Welcome! There are three main functions of this system: <br/>
    1. Query <br/>
    2. Aggregated Analysis<br/>
    3. Prediction on your clients' transaction behavior <br/>
    <br/>
    These are the tables and columns that you can query: <br/>
    <b>accounts</b>: account_id, district_id, frequency, date, bank_id <br/>
    <b>card</b>: card_id, disp_id, type, issued, bank_id <br/>
    <b>client</b>: client_id, birth_number, district_id, bank_id <br/>
    <b>disp</b>: disp_id, client_id, account_id, type, bank_id <br/>
    <b>loan</b>: loan_id, account_id, date, amount, duration, payments, status, bank_id <br/>
    <b>orders</b>: order_id, account_id, bank_to, account_to, amount, k_symbol, bank_id <br/>
    <b>trans</b>: trans_id, account_id, date, type, operation, amount, balance, k_symbol, bank, account, bank_id <br/>
</div>

<a name="qform">
<form id="qform" method="post" >
    Enter your query here: <br>
    <br>
    SELECT<br> <input align="center" type="text" name="columns" id = "columns" placeholder="column names" style="font-family: Helvetica Neue, Helvetica, Arial, sans-serif"><br>
    FROM <br><input type="text" name="table" id="table" placeholder="table name" style ="font-family: Helvetica Neue, Helvetica, Arial, sans-serif;"><br>
    WHERE <br><input type="text" name="condition" id="condition"  placeholder="condition" style = "font-family: Helvetica Neue, Helvetica, Arial, sans-serif;"><br/><br/>
    <input type="button" value="Submit query" onclick="query()">
    <br>
    <br>
    <!-- <span id = "result" >Result</span> -->
    <p id = "result"> Result </p>
</form>
    <form id="cnm" action="/download" method="POST" style = "z-index:11; width: 70%; margin-top: 0;
            margin-left:auto;
            margin-right:auto;">
        Your query result is: <button name="downloadBtn" id="exportbutton" style="background-color: #E27575; color: #FFF;  box-shadow: 1px 1px 5px #B6B6B6; border-radius: 3px;
            text-shadow: 1px 1px 1px #9E3F3F;
            cursor: pointer;">Export Result</button>
    </form>
</a>
<br>
<a name="analysis">
    <form action="/basic_analysis" method="post" style="height: 40%; width: 70%;background: #F7F7F7;
            margin-top: 3%;
            margin-left:auto;
            margin-right:auto;">
        <button style="background-color: #E27575; color: #FFF;  box-shadow: 1px 1px 5px #B6B6B6; border-radius: 3px;
            text-shadow: 1px 1px 1px #9E3F3F;
            cursor: pointer;">Get Aggregated Analysis</button>
        <p>{{analysis}}</p>
    </form>
</a>
<a name="prediction">
    <form action="/personal_analysis" method="get" style="height: 40%; width: 70%;background: #F7F7F7;
          margin-top: 3%;
          margin-left:auto;
          margin-right:auto;">
        <button style="background-color: #E27575; color: #FFF;  box-shadow: 1px 1px 5px #B6B6B6; border-radius: 3px;
            text-shadow: 1px 1px 1px #9E3F3F;
            cursor: pointer;">Predict an account next transaction</button>
    </form>
</a>
<script>
        function query() {
            // Check for SQL injection attack
            var field1 = document.getElementById("columns");
            var field2 = document.getElementById("table");
            var field3 = document.getElementById("condition");
             if(SqlInvalid(field1)||SqlInvalid(field2)||SqlInvalid(field3)){
                 alert("Invalid input");
                 return ;
             }
            $.ajax({
                url: '/GetData',
                type: 'POST',
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                data: $('#qform').serialize(),
                success: function (data) {
                    // $('#result').html(data);
                    CreateTable(JSON.parse(data));
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log('xHR: ' + xhr);
                    console.log('ajaxOption: ' + ajaxOptions);
                    console.log('thrownError: ' + thrownError);
                }

            })
                // .done(CreateTable(data))
        }

        function SqlInvalid(oField) {
            re = /select|and|or|insert|union|join|truncate|drop|update|delete|exec|sleep|--|'|"|&&|;|%/i;
            return re.test(oField.value);
        }

        function CreateTable(ojson) {
            var json = [];
            json.push(ojson);

            console.log(json);
            
            var col = [];
            for(var i = 0; i < json.length; i++) {
                for(var key in json[i]) {
                    if(col.indexOf(key) === -1) {
                        col.push(key);
                    }
                }
            }
            var table = document.createElement("table");

            var tr = table.insertRow(-1);

            for(var i = 0; i < col.length; i++) {
                var th = document.createElement("th");
                th.innerHTML = col[i];
                tr.appendChild(th);
            }
            for(var i = 0; i < json.length; i++) {
                tr = table.insertRow(-1);

                for(var j = 0; j < col.length; j++) {
                    var tabCell = tr.insertCell(-1);
                    tabCell.innerHTML = json[i][col[j]];
                }

            }
            var divContainer = document.getElementById("result");
            divContainer.innerHTML = "";
            divContainer.appendChild(table);
        }
</script>
</div>
</body>
</html>
